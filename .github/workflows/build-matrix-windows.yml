name: Build Matrix - Windows
run-name: ${{ github.actor }} is building Matrix (Windows) ðŸš€
on:
  workflow_dispatch:
    inputs:
      version:
        description: "Version tag (e.g., v1.0.0)"
        required: true
        type: string
      branch:
        description: "Branch to build from"
        required: false
        default: "main"
        type: string
  workflow_call:
    inputs:
      version:
        description: "Version tag (e.g., v1.0.0)"
        required: true
        type: string
      branch:
        description: "Branch to build from"
        required: false
        default: "main"
        type: string

permissions:
  contents: write

jobs:
  create-tag:
    if: ${{ github.event_name == 'workflow_dispatch' }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          ref: ${{ inputs.branch }}

      - name: Create and push tag
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Check if tag already exists on remote
          if git ls-remote --tags origin | grep -q "refs/tags/${{ inputs.version }}$"; then
            echo "Tag ${{ inputs.version }} already exists on remote, skipping tag creation"
          else
            git tag -a "${{ inputs.version }}" -m "Release ${{ inputs.version }}"
            git push origin "${{ inputs.version }}"
            echo "Tag ${{ inputs.version }} created and pushed successfully"
          fi

  build-matrix-windows:
    needs: [create-tag]
    if: ${{ always() && (needs.create-tag.result == 'success' || needs.create-tag.result == 'skipped') }}
    runs-on: windows-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          ref: ${{ inputs.branch }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: lts/*

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Rust Cache
        uses: actions/cache@v3
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            src-tauri/target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      - name: Build official package
        run: |
          npm install
          .\build.ps1

      - name: Upload official package to R2
        uses: ryand56/r2-upload-action@v1.4
        with:
          r2-account-id: ${{ secrets.R2_ACCOUNT_ID_NIO }}
          r2-access-key-id: ${{ secrets.R2_ACCESS_KEY_ID_NIO }}
          r2-secret-access-key: ${{ secrets.R2_SECRET_ACCESS_KEY_NIO }}
          r2-bucket: matrix
          source-dir: ./src-tauri/target/release/bundle/msi
          destination-dir: ./

      - name: Update version
        env:
          TIKMATRIX_API_KEY: ${{ secrets.TIKMATRIX_API_KEY }}
          API_KEY: ${{ secrets.API_KEY }}
        run: |
          node scripts/update-version.js

      - name: Clear uploaded files
        run: |
          Remove-Item -Path .\src-tauri\target\release\bundle\msi\* -Force -Recurse

      # IgMatrix whitelabel build and upload steps
      - name: Build IgMatrix whitelabel package
        run: |
          node scripts/build-whitelabel.js IgMatrix

      - name: Upload IgMatrix package to R2
        uses: ryand56/r2-upload-action@v1.4
        with:
          r2-account-id: ${{ secrets.R2_ACCOUNT_ID_NIO }}
          r2-access-key-id: ${{ secrets.R2_ACCESS_KEY_ID_NIO }}
          r2-secret-access-key: ${{ secrets.R2_SECRET_ACCESS_KEY_NIO }}
          r2-bucket: matrix
          source-dir: ./src-tauri/target/release/bundle/msi
          destination-dir: ./

      - name: Update IgMatrix version
        env:
          TIKMATRIX_API_KEY: ${{ secrets.TIKMATRIX_API_KEY }}
          API_KEY: ${{ secrets.API_KEY }}
        run: |
          node scripts/update-version.js --app=igmatrix --app-name=IgMatrix

      - name: Clear uploaded files
        run: |
          Remove-Item -Path .\src-tauri\target\release\bundle\msi\* -Force -Recurse

      - name: Update IgMatrix download url
        env:
          TIKMATRIX_API_KEY: ${{ secrets.TIKMATRIX_API_KEY }}
          API_KEY: ${{ secrets.API_KEY }}
        run: |
          node scripts/update-download-url.js --platform=windows --distributor=OFFICIAL --app=igmatrix --app-name=IgMatrix

      # TikZenX whitelabel build and upload steps
      - name: Build TikZenX whitelabel package
        run: |
          node scripts/build-whitelabel.js TikZenX

      - name: Upload TikZenX package to R2
        uses: ryand56/r2-upload-action@v1.4
        with:
          r2-account-id: ${{ secrets.R2_ACCOUNT_ID_NIO }}
          r2-access-key-id: ${{ secrets.R2_ACCESS_KEY_ID_NIO }}
          r2-secret-access-key: ${{ secrets.R2_SECRET_ACCESS_KEY_NIO }}
          r2-bucket: matrix
          source-dir: ./src-tauri/target/release/bundle/msi
          destination-dir: ./

      - name: Update TikZenX version
        env:
          TIKMATRIX_API_KEY: ${{ secrets.TIKMATRIX_API_KEY }}
          API_KEY: ${{ secrets.API_KEY }}
        run: |
          node scripts/update-version.js --app=tikzenx --app-name=TikZenX

      - name: Clear uploaded files
        run: |
          Remove-Item -Path .\src-tauri\target\release\bundle\msi\* -Force -Recurse

      - name: Update TikZenX download url
        env:
          TIKMATRIX_API_KEY: ${{ secrets.TIKMATRIX_API_KEY }}
          API_KEY: ${{ secrets.API_KEY }}
        run: |
          node scripts/update-download-url.js --platform=windows --distributor=OFFICIAL --app=tikzenx --app-name=TikZenX

      # Build and upload distributor packages
      - name: Build distributor packages
        run: |
          node scripts/build-distributor-packages-windows.js

      - name: Upload distributor packages to R2
        uses: ryand56/r2-upload-action@v1.4
        with:
          r2-account-id: ${{ secrets.R2_ACCOUNT_ID_NIO }}
          r2-access-key-id: ${{ secrets.R2_ACCESS_KEY_ID_NIO }}
          r2-secret-access-key: ${{ secrets.R2_SECRET_ACCESS_KEY_NIO }}
          r2-bucket: matrix
          source-dir: ./dist-distributors
          destination-dir: ./distributors

      - name: Clear uploaded files
        run: |
          Remove-Item -Path .\dist-distributors\* -Force -Recurse

      - name: Update distributor download urls
        env:
          TIKMATRIX_API_KEY: ${{ secrets.TIKMATRIX_API_KEY }}
          API_KEY: ${{ secrets.API_KEY }}
        run: |
          node scripts/update-download-url.js --platform=windows --all-distributors
